# Petal 桌面宠物系统实验报告

## 一、项目背景与目标

### 1.1 项目初衷与灵感

在数字化办公与学习日益普及的今天，用户长时间面对电脑屏幕已成为常态。这种环境下，人机交互缺乏温度，容易引发孤独感与工作疲劳。本项目旨在通过构建一个具有互动性的虚拟桌面宠物系统，为用户的数字生活增添情感陪伴与趣味元素，改善单一的桌面环境体验。

该项目的设计灵感来源于早期的桌面宠物软件以及现代虚拟助手应用，尝试将娱乐性与实用性相结合，以提升用户的使用愉悦度与工作效率。

### 1.2 主要目标

本项目的主要设计目标如下：

1. **提供情感陪伴与娱乐功能**  
   通过拟人化、卡通化的宠物形象与丰富的动画交互机制，为用户提供虚拟陪伴，缓解长时间使用计算机所带来的枯燥与压力。
   
2. **集成实用效率工具**  
   在娱乐的基础上，加入番茄钟、专注模式、提醒事项等功能模块，帮助用户更好地管理时间，提高工作与学习效率。

3. **技术实践与能力提升**  
   作为开发项目，本项目亦是小组全体对以下技术的学习与实践：
   - 使用 PyQt5 构建图形用户界面 (GUI)
   - 应用多线程技术实现后台任务与前台动画的并行处理
   - 利用 JSON 配置文件实现灵活的宠物行为定义与外观定制
   - 实现模块化设计，提高代码的可维护性与扩展性

### 1.3 目标用户群体

本系统适用于需要长时间使用计算机的各类人群，包括但不限于：

- 办公室职员
- 学生
- 软件开发者
- 平面设计师
- 其他希望在桌面环境中获得情感陪伴与效率辅助的用户

---

## 二、系统功能介绍

Petal 是一款集桌面宠物与效率工具于一体的桌面应用程序。其核心功能包括宠物显示、状态管理、用户交互、计划任务管理及资源配置等多个模块，具体如下：

### 2.1 桌面宠物显示与动画

宠物以无边框窗口形式显示于桌面之上，具备多种预设动画效果，如行走、睡觉、拖拽响应、掉落模拟等。宠物行为由内部设定的概率机制控制，能够随机播放不同的动作序列，从而呈现出较高的自主性与生动性。

### 2.2 宠物状态管理

系统为宠物设置了两个状态值：HP（生命值）与 EM（情绪值/能量值），均通过进度条形式在界面上展示。

- HP 与 EM 的数值会随着时间自动递减，分别由 `Scheduler_worker` 类中的 `change_hp()` 与 `change_em()` 方法控制，并受配置参数 `hp_interval` 与 `em_interval` 影响。
- 当前版本暂未实现通过物品或特定交互恢复状态值的功能，该部分将在后续版本中完善。

### 2.3 用户交互功能

系统支持多种用户交互方式，包括：

- **鼠标拖拽**：用户可通过左键拖动宠物位置，此功能由 `PetWidget` 中的 `mousePressEvent` 和 `mouseMoveEvent` 实现。
- **拖拽释放后的物理模拟**：释放鼠标后，宠物将依据速度与方向模拟抛出与下落效果，利用重力参数进行位移计算，相关逻辑位于 `Interaction_worker` 的 `mousedrag()` 与 `drop()` 方法中。
- **右键菜单**：点击宠物右键可弹出上下文菜单，支持退出程序、切换宠物、打开设置等功能，由 `_show_right_menu()` 方法实现。

### 2.4 计划任务与效率工具（由 `Scheduler_worker` 管理）

系统内置多项定时任务，旨在辅助用户进行时间管理与日常事务提醒：

#### （1）番茄钟功能

- 支持启动多个番茄钟周期，每个周期包含默认25分钟的工作时间和5分钟的休息时间。
- 提供开始、结束提示及整体流程完成反馈。
- 支持中途取消操作。
- 若当前已有番茄钟或专注模式运行，则新启动请求将被拒绝，避免冲突。

#### （2）专注模式

- 用户可设定专注时间段，支持按持续时间或指定结束时间点设置。
- 专注期间宠物可能触发特定表现（当前仅框架搭建，具体表现待实现）。
- 开始与结束时均有对话框提示。
- 同样支持中途取消与冲突检测。

#### （3）提醒事项

- 支持一次性与重复性提醒，设定方式包括相对时间（如“X小时Y分钟后”）与绝对时间点（如“每天HH:MM”）。
- 到达设定时间后，系统通过对话框提示用户相关信息。

#### （4）定时问候

- 根据系统时间（早、午、晚等）自动生成问候语并显示，增强与用户的互动性。

### 2.5 多宠物支持（基础实现）

系统通过 `data/pets.json` 文件管理可用宠物列表及其对应的配置路径。`PetWidget` 可加载指定宠物或默认第一个宠物，理论上支持通过右键菜单切换角色，但该部分 UI 交互尚未完全实现。

### 2.6 配置与资源管理

宠物的行为参数、动画帧、图像资源等信息均通过 JSON 配置文件（如 `data/Kitty.json`）定义。系统资源（如字体、图标、动画图片）统一存放于 `res/` 目录下，便于集中管理和后期扩展。

---

## 三、系统架构与模块设计

### 3.1 主程序入口（`run_Petaler.py`）

该脚本负责启动整个应用程序，主要职责包括：

- 从 `data/pets.json` 加载宠物数据
- 初始化 PyQt5 应用实例
- 应用全局样式表以美化界面控件
- 创建并显示主窗口类 `PetWidget`
- 启动 Qt 事件循环

### 3.2 核心类与模块（`Petaler.py`）

#### 3.2.1 `PetWidget(QWidget)` 类

作为系统的主界面窗口类，主要实现以下功能：

- 初始化无边框、透明背景的桌面窗口
- 加载宠物配置与图像资源
- 设置并更新 UI 控件（如进度条、标签）
- 处理用户输入事件（鼠标拖拽、右键菜单等）
- 管理三个核心线程：`Animation_worker`、`Interaction_worker`、`Scheduler_worker`
- 实现信号与槽机制，确保线程间通信安全
- 系统托盘图标的初始化与菜单绑定

#### 3.2.2 `modules.py` —— 后台工作线程类

该模块定义了三个关键线程类，分别负责不同类型的后台任务：

##### Animation_worker

- 执行常规动画播放与随机动作选择
- 通过定时器控制动画帧率
- 支持暂停、恢复与终止操作

##### Interaction_worker

- 处理用户交互行为及其后续动画响应
- 实现拖拽后的物理运动模拟
- 支持执行预设动画序列

##### Scheduler_worker

- 利用 APScheduler 调度定时任务
- 管理 HP/EM 自动减少、番茄钟、专注模式、提醒事项等计划任务
- 提供对话框提示与状态更新机制

#### 3.2.3 `conf.py` —— 配置类

- `PetConfig` 类封装宠物配置信息，包括刷新频率、动作定义、初始状态等
- `Act` 类表示单个动作单元，包含图像帧、移动方向、播放次数等属性

#### 3.2.4 `settings.py` —— 全局变量模块

- 提供跨模块共享的状态变量，如当前图像帧、移动速度、是否处于拖拽状态等
- 保证线程间状态一致性

#### 3.2.5 `utils.py` —— 工具函数库

- 包括 JSON 文件读取、资源路径解析、图像加载等通用函数

#### 3.2.6 `extra_windows.py` —— 辅助窗口模块

- 包含设置窗口、关于窗口等额外 GUI 界面，便于用户自定义宠物行为与查看系统信息

### 3.3 数据目录（`data/`）

- `pets.json`：存储所有可用宠物名称与对应配置文件路径
- `Kitty.json`（及其他宠物配置文件）：详细定义宠物的各项行为参数与资源路径
- `remindme.txt`：用于保存用户设定的提醒事项（当前格式尚未标准化）

### 3.4 资源目录（`res/`）

- `font/`：存放自定义字体文件
- `icons/`：图标资源，用于界面元素与系统托盘
- `role/PetName/`：各宠物角色专属图像资源目录，包含动画帧、动作序列等图像文件

---

## 四、总结与展望

本项目基于 PyQt5 实现了一个兼具娱乐性与实用性的桌面宠物系统，不仅实现了基本的动画交互与状态管理功能，还集成了多种效率辅助工具。通过模块化设计与多线程机制，提升了系统的稳定性与可扩展性。

未来可进一步完善宠物状态恢复机制、优化多宠物切换交互、增强资源动态加载能力，并探索语音交互、AI行为模拟等高级功能，以提升用户体验与智能化水平。

---